name: Deploy MERN App to Hostinger VPS

on:
     push:
          branches:
               - main

jobs:
     deploy:
          runs-on: ubuntu-latest

          steps:
               - name: Checkout Code
                 uses: actions/checkout@v3

               - name: Debug environment and permissions
                 run: |
                      echo "Home directory: $HOME"
                      echo "Current user: $(whoami)"
                      ls -ld ~/.ssh || echo ".ssh directory does not exist"
                      ls -al ~/.ssh || echo "No contents in .ssh"

               - name: Debug SSH Key
                 run: |
                      echo "${{ secrets.VPS_SSH_KEY }}" | head -n 10  # Print the first 10 lines to verify the SSH key format

               - name: Setup SSH Key
                 run: |
                      # Create .ssh directory if it doesn't exist on the GitHub runner
                      mkdir -p ~/.ssh

                      # Write the SSH key from GitHub secrets into the file
                      echo "${{ secrets.VPS_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa

                      # Set the correct permissions for the SSH key
                      chmod 600 ~/.ssh/id_rsa

                      # Add VPS host to known hosts to avoid SSH prompt
                      ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

               - name: Deploy to VPS using tmux
                 run: |
                      # SSH into your VPS and perform the deployment
                      ssh -i ~/.ssh/id_rsa ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
                        # Ensure we are in the correct directory for the backend on the VPS
                        cd /home/ubuntu/kappes_backend

                        # Pull the latest code from Git
                        echo "Pulling latest code..."
                        git pull origin main

                        # Install dependencies if needed
                        echo "Installing dependencies..."
                        npm install

                        # Build the app (if needed)
                        echo "Building app..."
                        npm run build

                        # Restart the backend server inside the tmux session
                        echo "Restarting backend server in tmux..."
                        tmux send-keys -t backend 'cd /home/ubuntu/kappes_backend && npm start' C-m

                        echo "Deployment successful!"
                      EOF
