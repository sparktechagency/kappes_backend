name: Deploy MERN App to Hostinger VPS

on:
     push:
          branches:
               - main

jobs:
     deploy:
          runs-on: ubuntu-latest

          steps:
               - name: Checkout Code
                 uses: actions/checkout@v3

               - name: Setup SSH Key
                 run: |
                      mkdir -p ~/.ssh
                      echo "${{ secrets.VPS_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
                      chmod 600 ~/.ssh/id_rsa
                      ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

               - name: Deploy to VPS using tmux
                 run: |
                      ssh -i ~/.ssh/id_rsa ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
                        # Ensure we are in the correct directory for the backend
                        cd /home/ubuntu/kappes_backend

                        # Pull latest code from Git
                        echo "Pulling latest code..."
                        git pull origin main

                        # Install dependencies (if needed)
                        echo "Installing dependencies..."
                        npm install

                        # Build the app (frontend build)
                        echo "Building app (if needed)..."
                        npm run build

                        # Restart the backend server inside the tmux session
                        echo "Restarting backend server in tmux..."
                        tmux send-keys -t backend 'cd /home/ubuntu/kappes_backend && npm start' C-m

                        echo "Deployment successful!"
                      EOF
